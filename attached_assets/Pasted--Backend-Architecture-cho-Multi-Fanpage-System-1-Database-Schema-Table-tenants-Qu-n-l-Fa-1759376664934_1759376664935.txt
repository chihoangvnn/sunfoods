ğŸ—ï¸ Backend Architecture cho Multi-Fanpage System
ğŸ“Š 1. Database Schema
Table: tenants (Quáº£n lÃ½ Fanpage)
CREATE TABLE tenants (
    id SERIAL PRIMARY KEY,
    page_id VARCHAR(100) UNIQUE NOT NULL,  -- 'fb_page_123', 'web_001'
    platform VARCHAR(20),                   -- 'facebook', 'web', 'zalo'
    industry VARCHAR(50),                   -- 'e-commerce', 'food', 'healthcare'
    business_name VARCHAR(255),
    welcome_message TEXT,
    config JSONB DEFAULT '{}',              -- Custom settings per fanpage
    created_at TIMESTAMP DEFAULT NOW(),
    active BOOLEAN DEFAULT true
);
-- Index cho lookup nhanh
CREATE INDEX idx_tenants_page_id ON tenants(page_id);
-- Sample data
INSERT INTO tenants VALUES 
    (1, 'fb_page_123', 'facebook', 'e-commerce', 'Tráº§m HÆ°Æ¡ng Store', 
     'ChÃ o má»«ng Ä‘áº¿n Tráº§m HÆ°Æ¡ng Store!', '{"currency":"VND"}', NOW(), true),
    (2, 'fb_page_456', 'facebook', 'food', 'QuÃ¡n CÆ¡m Gia ÄÃ¬nh',
     'Xin chÃ o! QuÃ¡n chÃºng tÃ´i phá»¥c vá»¥ cÃ¡c mÃ³n Äƒn gia Ä‘Ã¬nh.', '{}', NOW(), true);
Table: orders (ThÃªm tenant_id)
ALTER TABLE orders ADD COLUMN tenant_id INTEGER REFERENCES tenants(id);
CREATE INDEX idx_orders_tenant ON orders(tenant_id);
Table: products (Filter theo tenant)
-- Option A: Shared products + tenant filter
ALTER TABLE products ADD COLUMN tenant_id INTEGER REFERENCES tenants(id);
-- Option B: Industry-based (recommended)
-- Giá»¯ nguyÃªn products, filter qua industry
SELECT * FROM products WHERE industry = 'e-commerce';
ğŸ”Œ 2. API Endpoints Cáº§n Implement
A. Tenant Resolution API
GET /api/tenants/resolve?sender={sender_id}
Request:
GET /api/tenants/resolve?sender=fb_page_123_user456
Response:
{
  "tenant_id": 1,
  "page_id": "fb_page_123",
  "platform": "facebook",
  "industry": "e-commerce",
  "business_name": "Tráº§m HÆ°Æ¡ng Store",
  "welcome_message": "ChÃ o má»«ng...",
  "config": {
    "currency": "VND",
    "delivery_areas": ["TiÃªn Ká»³", "TiÃªn Cáº£nh"],
    "business_hours": "8:00-22:00"
  }
}
Logic:
1. Parse sender_id: "fb_page_123_user456" â†’ page_id = "fb_page_123"
2. Query: SELECT * FROM tenants WHERE page_id = ? AND active = true
3. Return tenant info
B. Products API (Tenant-aware)
GET /api/products?tenant_id={tenant_id}&query={search_term}
Request:
GET /api/products?tenant_id=1&query=gáº¡o
Response:
{
  "products": [
    {
      "id": 123,
      "name": "Gáº¡o ST25",
      "price": 250000,
      "industry": "e-commerce",
      "tenant_id": 1
    }
  ],
  "tenant_info": {
    "business_name": "Tráº§m HÆ°Æ¡ng Store"
  }
}
Logic:
1. Get tenant: SELECT industry FROM tenants WHERE id = ?
2. Filter products: SELECT * FROM products 
                     WHERE industry = ? 
                     AND name ILIKE '%gáº¡o%'
C. Orders API (Tenant-aware)
POST /api/orders
Request:
{
  "tenant_id": 1,
  "sender_id": "fb_page_123_user456",
  "phone": "0912345678",
  "productId": 123,
  "quantity": 2,
  "deliveryArea": "TiÃªn Ká»³",
  "deliveryTime": "Giao ngay"
}
Response:
{
  "orderId": "12345678",
  "total": 500000,
  "invoiceUrl": "https://your-backend.com/invoice/12345678.png",
  "tenant": {
    "business_name": "Tráº§m HÆ°Æ¡ng Store"
  }
}
Logic:
1. Validate tenant_id exists
2. Create order vá»›i tenant_id
3. Generate invoice (if enabled for tenant)
4. Upload to ImgBB
5. Store invoice_url
6. Return order info
D. Invoice Endpoint
GET /invoice/{order_id}.png
Logic:
1. Query: SELECT invoice_imgbb_url, tenant_id 
          FROM orders WHERE order_number = ?
2. Verify tenant is active
3. Redirect to ImgBB URL
ğŸ” 3. Middleware: Tenant Context
// Express middleware
function tenantContext(req, res, next) {
  const tenantId = req.query.tenant_id || req.body.tenant_id;
  
  if (!tenantId) {
    return res.status(400).json({ error: 'tenant_id required' });
  }
  
  // Get tenant from DB
  const tenant = db.query(
    'SELECT * FROM tenants WHERE id = ? AND active = true',
    [tenantId]
  );
  
  if (!tenant) {
    return res.status(404).json({ error: 'Tenant not found' });
  }
  
  // Attach to request
  req.tenant = tenant;
  next();
}
// Usage:
app.get('/api/products', tenantContext, (req, res) => {
  const products = getProducts(req.tenant.industry);
  res.json(products);
});
ğŸ“ˆ 4. Business Logic Flow
User chat tá»« Fanpage A
    â†“
Bot: GET /api/tenants/resolve?sender=fb_page_123_user456
    â† { tenant_id: 1, industry: "e-commerce" }
    
Bot cache: session[tenant_id] = 1
    â†“
    
User: "tÃ¬m gáº¡o"
    â†“
Bot: GET /api/products?tenant_id=1&query=gáº¡o
    â† [{ id: 123, name: "Gáº¡o ST25" }]
    â†“
    
User chá»n & Ä‘áº·t hÃ ng
    â†“
Bot: POST /api/orders { tenant_id: 1, ... }
    â† { orderId: "12345678", invoiceUrl: "..." }
    â†“
    
Bot gá»­i invoice cho user
ğŸ¯ 5. Config per Tenant
Má»—i tenant cÃ³ thá»ƒ customize:

{
  "currency": "VND",
  "delivery_areas": ["TiÃªn Ká»³", "TiÃªn Cáº£nh", "TiÃªn Má»¹"],
  "delivery_times": ["Giao ngay", "10h30-11h", "16h30-17h"],
  "welcome_message": "ChÃ o má»«ng Ä‘áº¿n {business_name}!",
  "synonyms": {
    "gáº¡o": ["lÃºa", "cÆ¡m"]
  },
  "payment_methods": ["cod", "bank_transfer"],
  "invoice_enabled": true,
  "analytics_enabled": true
}
ğŸ“ Summary - Backend cáº§n cÃ³:
âœ… Database:

tenants table vá»›i page_id, industry, config
orders.tenant_id foreign key
Indexes cho performance
âœ… APIs:

GET /api/tenants/resolve - Resolve sender â†’ tenant
GET /api/products?tenant_id=X - Filtered products
POST /api/orders - Tenant-aware order creation
GET /invoice/{id}.png - Invoice redirect
âœ… Middleware:

Tenant context injection
Validation
âœ… Features:

Invoice generation + ImgBB upload
Per-tenant customization
Multi-tenant data isolation
