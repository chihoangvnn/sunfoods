Dáº¡ em Ä‘Ã£ phÃ¢n tÃ­ch xong anh! ÄÃ¢y lÃ  bÃ¡o cÃ¡o chi tiáº¿t:

ğŸ” PHÃ‚N TÃCH Váº¤N Äá»€ Báº¢O Máº¬T
1ï¸âƒ£ Bot decrypt á»Ÿ Ä‘Ã¢u? Táº¡i sao fail?
Vá»‹ trÃ­: customer_accounts.py - method _decrypt_customer_data() (line 74-124)

CÆ¡ cháº¿ decrypt:

decrypted_phone = self._decrypt_pii(customer.phone_number)
# PhÃ¡t hiá»‡n fail:
phone_failed = customer.phone_number and not decrypted_phone
Táº¡i sao fail?

âŒ 29 customers Ä‘Æ°á»£c mÃ£ hÃ³a báº±ng encryption key CÅ¨ (key táº¡m khi server khá»Ÿi Ä‘á»™ng)
âŒ Server restart â†’ dÃ¹ng key Má»šI (tá»« env variable)
âŒ Key mismatch â†’ _decrypt_pii() tráº£ vá» "" (empty) â†’ FAIL!
2ï¸âƒ£ Hash 0275246a0a tá»« Ä‘Ã¢u ra?
Nguá»“n gá»‘c: Line 92 trong customer_accounts.py

phone_hash = getattr(customer, 'phone_hash', 'unknown')  # SHA-256 hash
'phone_number': f"0{phone_hash[-9:]}"  # Láº¥y 9 kÃ½ tá»± cuá»‘i
Quy trÃ¬nh:

Phone 0905608298 â†’ SHA-256 hash â†’ d7a4a01a0275246a0a... (64 kÃ½ tá»±)
Láº¥y 9 kÃ½ tá»± cuá»‘i: 0275246a0a
ThÃªm prefix 0 â†’ 0275246a0a âœ…
ÄÃ¢y lÃ  FALLBACK khi decrypt fail!

3ï¸âƒ£ Bot gá»­i hash lÃªn backend nhÆ° tháº¿ nÃ o?
Flow nguy hiá»ƒm:

Step 1: User nháº­p 0905608298

# Line 1633: TÃ¬m customer cÅ©
existing_customer = customer_manager.find_by_phone("0905608298")
Step 2: Decrypt FAIL â†’ tráº£ vá» hash

# Line 1637-1638: Láº¥y data bá»‹ corrupt
name = existing_customer.get('full_name', 'KhÃ¡ch hÃ ng')  # â†’ "KhÃ¡ch hÃ ng"
address = existing_customer.get('address', 'KhÃ´ng cÃ³ Ä‘á»‹a chá»‰')  # â†’ "Cáº­p nháº­t sau"
Step 3: LÆ°u hash vÃ o session

# Line 1641-1642: LÆ¯U HASH thay vÃ¬ sá»‘ tháº­t!
store_session_context(sender, 'customer_phone', normalized_phone)  # â† HASH!
store_session_context(sender, 'customer_data', existing_customer)  # â† Data bá»‹ corrupt
Step 4: Táº¡o order â†’ gá»­i hash lÃªn backend

# Khi táº¡o order:
customer_phone = existing_customer.get('phone_number')  # â†’ "0275246a0a" âŒ
payload = {
    "customerPhone": "0275246a0a",  # â† HASH gá»­i lÃªn backend!
    ...
}
âŒ Backend KHÃ”NG VALIDATE! Nháº­n hash nhÆ° sá»‘ tháº­t â†’ lÆ°u vÃ o database!

4ï¸âƒ£ 29 customers Ä‘Æ°á»£c táº¡o khi nÃ o?
Timeline:

TrÆ°á»›c Ä‘Ã³: Server dÃ¹ng encryption key Táº M (generate má»—i láº§n khá»Ÿi Ä‘á»™ng)
29 customers Ä‘Æ°á»£c táº¡o vÃ  mÃ£ hÃ³a báº±ng key táº¡m
Server restart â†’ key táº¡m bá»‹ máº¥t
Fix applied: Persist key qua CUSTOMER_DATA_ENCRYPTION_KEY env
Háº­u quáº£: 29 customers cÅ© decrypt FAIL â†’ hash xuáº¥t hiá»‡n!
ğŸ”§ GIáº¢I PHÃP TOÃ€N DIá»†N
Fix 1: Validate Phone TRÆ¯á»šC KHI gá»­i backend â­
# ThÃªm validation sau khi decrypt:
if existing_customer.get('_decryption_failed'):
    # REJECT hash, force user re-enter phone!
    return "Dá»¯ liá»‡u khÃ¡ch hÃ ng bá»‹ lá»—i, vui lÃ²ng nháº­p láº¡i SÄT"
Fix 2: Backend validate phone format
# Backend API pháº£i check:
if not re.match(r'^0\d{9}$', customerPhone):
    return 400, "Invalid phone format"
Fix 3: Cleanup corrupted data
Bot DB: XÃ³a 29 local customer_accounts (hoáº·c re-encrypt vá»›i key má»›i)
Backend DB: XÃ³a customers vá»›i phone = hash pattern ^0[a-f0-9]{9}$
Fix 4: Error handling Ä‘Ãºng
# Khi decrypt fail â†’ KHÃ”NG dÃ¹ng fallback hash!
if phone_failed:
    raise DecryptionError("Cannot decrypt - customer must re-verify")
Anh muá»‘n em fix theo hÆ°á»›ng nÃ o áº¡?

âœ… Quick fix: Validate _decryption_failed flag â†’ force re-enter phone
âœ… Cleanup: XÃ³a 29 corrupted customers (bot + backend)
âœ… Long-term: Remove fallback hash logic hoÃ n toÃ n