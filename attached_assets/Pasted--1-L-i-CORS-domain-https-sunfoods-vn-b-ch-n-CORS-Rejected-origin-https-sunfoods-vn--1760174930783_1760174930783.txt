âš ï¸ 1ï¸âƒ£ Lá»—i CORS â€“ domain https://sunfoods.vn bá»‹ cháº·n
ğŸš« CORS: Rejected origin https://sunfoods.vn

ğŸ“Œ NguyÃªn nhÃ¢n:

Backend chá»‰ cho phÃ©p má»™t vÃ i domain:

Allowed: http://localhost:3000, http://localhost:5000, ...


KhÃ´ng cÃ³ https://sunfoods.vn.

âœ… CÃ¡ch sá»­a:

Má»Ÿ file /var/www/sun/backend/src/index.ts
(táº§m dÃ²ng 85 trong log cÃ³ nháº¯c tá»›i)

TÃ¬m Ä‘oáº¡n nhÆ°:

const allowedOrigins = [
  'http://localhost:3000',
  'http://localhost:5000',
  'https://your-storefront.vercel.app',
  ...
];


ğŸ‘‰ ThÃªm domain cá»§a báº¡n vÃ o:

const allowedOrigins = [
  'http://localhost:3000',
  'http://localhost:5000',
  'https://sunfoods.vn',
  'https://www.sunfoods.vn',
];


Sau Ä‘Ã³ restart backend:

pm2 restart backend-api

âš ï¸ 2ï¸âƒ£ Lá»—i â€œFailed to compile pattern for /api/webhooks/facebook/:appId?â€
PathError [TypeError]: Unexpected ? at index 29

ğŸ“Œ NguyÃªn nhÃ¢n:

CÃº phÃ¡p /api/webhooks/facebook/:appId? trong path-to-regexp má»›i khÃ´ng cÃ²n há»— trá»£ ? á»Ÿ cuá»‘i nhÆ° tháº¿ nÃ y ná»¯a.

âœ… CÃ¡ch sá»­a:

Thay cÃ¡c route kiá»ƒu:

router.get('/api/webhooks/facebook/:appId?', handler)


báº±ng:

router.get('/api/webhooks/facebook/:appId', handler)


vÃ  náº¿u muá»‘n appId lÃ  tÃ¹y chá»n, dÃ¹ng middleware check thá»§ cÃ´ng:

router.get('/api/webhooks/facebook/:appId', (req, res) => {
  const appId = req.params.appId || null;
  ...
});


Hoáº·c dÃ¹ng phiÃªn báº£n path-to-regexp cÅ© (v7 trá»Ÿ xuá»‘ng):

npm install path-to-regexp@0.1.7


âš ï¸ CÃ¡ch nÃ y chá»‰ nÃªn dÃ¹ng náº¿u báº¡n chÆ°a muá»‘n sá»­a code, vÃ¬ báº£n cÅ© Ä‘Ã£ deprecated.

âš ï¸ 3ï¸âƒ£ SYSTEM HEALTH CRITICAL â€“ No workers online
'ğŸ”´ CRITICAL: No workers are online - Auto-posting system is offline'

ğŸ“Œ NguyÃªn nhÃ¢n:

Module â€œworkersâ€ (vÃ­ dá»¥: queue xá»­ lÃ½ tá»± Ä‘á»™ng / auto-posting job) bá»‹ crash hoáº·c khÃ´ng khá»Ÿi Ä‘á»™ng khi backend start.

âœ… CÃ¡ch kiá»ƒm tra:
pm2 list


Náº¿u khÃ´ng cÃ³ process nÃ o tÃªn workers hoáº·c backend-worker â†’ cáº§n start láº¡i:

pm2 start /var/www/sun/backend/src/workers.ts --name backend-worker


Hoáº·c náº¿u báº¡n dÃ¹ng cron hay Bull queue, kiá»ƒm tra Redis:

systemctl status redis

âš ï¸ 4ï¸âƒ£ Cáº£nh bÃ¡o cáº¥u hÃ¬nh mÃ´i trÆ°á»ng (Environment)
âš ï¸  VAPID keys not configured!
âš ï¸  TikTok credentials máº«u!
âš ï¸  Replit OAuth credentials not found.
âš ï¸  Redis not configured.


â†’ ÄÃ¢y lÃ  cáº£nh bÃ¡o, khÃ´ng pháº£i lá»—i, nhÆ°ng báº¡n nÃªn thÃªm biáº¿n mÃ´i trÆ°á»ng thá»±c táº¿ trong file .env:

VAPID_PUBLIC_KEY=xxx
VAPID_PRIVATE_KEY=xxx
TIKTOK_APP_ID=xxx
TIKTOK_APP_SECRET=xxx
REDIS_URL=redis://127.0.0.1:6379


Rá»“i restart:

pm2 restart backend-api